<!DOCTYPE html>
<html>

<head>
  <title>Off Heap enhancements</title>
  <!-- <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script> -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Infinispan is a distributed in-memory key/value data store with optional schema, available under the Apache License 2.0.">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<!--   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125236544-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
 
    gtag('config', 'UA-125236544-1');
  </script> -->


</head>

<body class="blog">
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/infinispan-logo-white.png" class="project-logo" title="Infinispan Logo"></a>
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/learn/">Learn <i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/introduction" class="">Introduction</a></li>
          <li><a href="/features" class="">Features</a></li>
          <li><a href="/documentation" class="">Documentation</a></li>
          <li><a href="/tutorials" class="">Tutorials</a></li>
          <li><a href="/videos" class="">Videos</a></li>
          <li><a href="/references" class="">References</a></li>
          <li><a href="/experiments" class="">Experiments</a></li>
          <li><a href="/roadmap" class="">Roadmap</a></li>
        </ul>
      </li>
      <li>
        <a href="/use-cases/" class="">Use Cases</a>
      </li>
      <li>
        <a href="/community/" class="">Community</a>
      </li>
      <li>
        <a href="/blog/" class="active">Blog</a>
      </li>
      <li>
        <a href="/download/" class="">Download</a>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="component-slim full-width-bg dark-bg light-blue">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <a href="/blog">Blogs</a> <i class="fas fa-chevron-right"></i> Off Heap enhancements
    </div>
  </div>
</div>
<div class="post-page grid-wrapper">
  <div class="grid__item width-10-12 width-12-12-m doc-content">
    <h1>Off Heap enhancements</h1>
    <div class="post-date">June 09, 2020
      Tags: <a href="/blog/tag/off-heap">off-heap</a> <a href="/blog/tag/storage">storage</a> 
    </div>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m margin-tb-sm">
        <p class="byline">By William Burns</p>
      </div>
      <div class="grid__item width-12-12">
          <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The off heap implementation in Infinispan has become much more widely used since its introduction.
There have been some issues and improvements identified to get this storage type more in line with
its heap counterpart.
For those of you that are unware the off-heap setting is actually only "off" the JVM heap and still resides in
the native memory of the application.</p>
</div>
<div class="paragraph">
<p>The best part of all the below changes is the user does not need to change anything, other than
configuring Off Heap storage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resizing-off-heap-container">Resizing Off Heap Container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For those of you that have used/configured off heap storage before you may have noticed that there
was a configuration option named address count.
This setting allowed you to configure how many address pointers the container had.
You can think of this as essentially how many buckets you have in a HashMap.
Unfortunately the number of pointers was fixed and therefore the user would have to know
how many elements they expected to have.</p>
</div>
<div class="paragraph">
<p>This setting also had another problem.
If the user required a larger size of elements this would increase startup time
as the container can be iterated upon multiple times when it is empty.
Iterating over a container of one million empty pointers would be much slower
than iterating over one of only 1024 for example.</p>
</div>
<div class="paragraph">
<p>I am glad to say as of Infinispan 10.0.0.Final this setting and the performance of
iteration have been greatly improved.</p>
</div>
<div class="sect2">
<h3 id="configuration">Configuration</h3>
<div class="paragraph">
<p>The address count variable is now ignored and instead the off heap based
container will start at smaller amount of "buckets" in the range of 128 or 256.
We then apply a load factor of .75, which means we will automatically increase
the size of the underlying "buckets" once we have inserted a number of entries
being 75% or larger than the current "bucket" size.</p>
</div>
<div class="paragraph">
<p>The resize operation will grow to have double the amount of "buckets" it had prior.
The resize operation will be performed concurrently with other operations, providing
minimal blocking as we have locks equal to the number of CPUs times two.</p>
</div>
<div class="paragraph">
<p>This will allow for a cache with off heap to be started significantly faster and
relieves some configuration options that were unneeded.
Note that the map, just like a java.util.HashMap, will not decrease the number of
"buckets" once it grows to a given size.</p>
</div>
</div>
<div class="sect2">
<h3 id="iteration-changes">Iteration changes</h3>
<div class="paragraph">
<p>I mentioned that iteration was slower during startup of larger number of "buckets".
This was due to it possibly having a large number of them, however it was also
plauged by an ineffecient way of iterating over them.
In addition to rewriting the resize operation, we have also optimized the memory
layout so that "buckets" can be iterated sequentially which provides more mechanical
sympathy.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hash-changes">Hash changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This one is rather short and sweet, but the old hash algorithm we used would cause
too many collisions for objects that had hash functions that returned values in a
similar range, such as java.lang.Integer and java.util.String (with shared startubg
characters).</p>
</div>
<div class="paragraph">
<p>Therefore it has been changed to provide a bit better spreading. This is part
of ISPN 10.0.0.Final.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expiration-bugs">Expiration bugs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unfortunately off heap had a few issues with expiration.
It didn&#8217;t support max idle and expiration metadata was not properly transferred
to new nodes during state transfer.</p>
</div>
<div class="paragraph">
<p>In addition to max idle algorithm being rewritten, Off heap now properly supports
max idle as of 10.1.4.Final and 11.0.0.Final.</p>
</div>
<div class="paragraph">
<p>Off heap metadata transferred to new nodes has been fixed in 10.1.8.Final and
11.0.0.Final.</p>
</div>
</div>
</div>
          
      </div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/infinispan-logo.png" class="project-logo" title="Infinispan Logo"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Infinispan is released under the Apache 2.0 open source license. Learn more about the <a href='LINK_NEEDED' target='_blank'>Apache Software License 2.0</a>.<br/><br/>This website built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='LINK_NEEDED' target='_blank'>fork the website</a> and show us what youâ€™ve got.</p>

    
      <div class="width-1-12 project-links">
        <b>Navigation</b>
        <ul class="footer-links width-1-12">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/LINK_NEEDED">Features</a></li>
          
            <li><a href="/LINK_NEEDED">Docs</a></li>
          
            <li><a href="/LINK_NEEDED">Tutorials</a></li>
          
            <li><a href="/LINK_NEEDED">Videos</a></li>
          
            <li><a href="/LINK_NEEDED">Use Cases</a></li>
          
            <li><a href="/LINK_NEEDED">Community</a></li>
          
            <li><a href="/LINK_NEEDED">Download</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>Contribute</b>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://issues.jboss.org/browse/ISPN">Submit a Bug</a></li>
          
            <li><a href="https://github.com/infinispan">Write Code</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>Follow Us</b>
        <ul class="footer-links width-1-12">
          
            <li><a href="/LINK_NEEDED">Blog</a></li>
          
            <li><a href="https://twitter.com/infinispan">Twitter</a></li>
          
        </ul>
      </div>
    

    <div class="width-6-12 more-links">
      <div class="grid-wrapper">
        <div class="width-6-12">
          <b>A Member of</b><br/>

          <a href="LINK_NEEDED" target="_blank"><img src="/assets/images/footer/leads.png">
          </a>
          <a href="LINK_NEEDED" target="_blank"><img src="/assets/images/footer/cloud-tm.png"></a>
          <br/>
          <a href="LINK_NEEDED" target="_blank"><img src="/assets/images/footer/cloud-button.png"></a>

        </div>
        <div class="width-6-12">

          <b>Thanks to</b><br/>
          <a href="LINK_NEEDED" target="_blank">JetBrains Intellj IDEA</a><br/>
          <a href="LINK_NEEDED" target="_blank"><img src="/assets/images/footer/jetbrains.png">
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
  <div class="content-slim redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
      | <a href="https://www.redhat.com/en/about/privacy-policy">Red Hat Privacy Policy</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/truncate-list.js"></script>

<!--   <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script> -->
</body>

</html>
